/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("zzem.fo.visibility.util.formatter");jQuery.sap.require("sap.ui.model.FilterOperator");sap.ui.core.mvc.Controller.extend("zzem.fo.visibility.view.Master",{_oListItemTemplate:null,_error:false,_wrongProperty:null,_aStaticFilters:undefined,_searchFilter:undefined,_aFilterArray:undefined,_oKeyValueMapping:undefined,_aFilterValues:undefined,_oVariants:undefined,_oTmpKeyValueMapping:undefined,_oValueDialog:undefined,_getValueDialog:function(c){if(!this._oValueDialog||c){this._oValueDialog=sap.ui.xmlfragment("zzem.fo.visibility.fragments.FilterValueDialog",this)}return this._oValueDialog},onInit:function(){var j,k;var p;var u;this._oListItemTemplate=sap.ui.xmlfragment("zzem.fo.visibility.fragments.MasterListItem",this);this._aStaticFilters=[];var f=[];var t=this;this._oKeyValueMapping={};this._aFilterValues=[];this._oVariants={};var d=false;var D=["P_CalendarTimeFrame","P_TimeZone","DeliveryStatus","TransportationStatus","TransportationPhase","Carrier","ShippingType","DestinationLocationCityName","DestinationLocationCountry","DestinationLocation","SourceLocationCityName","SourceLocationCountry","SourceLocation","TransportationMode","TransportationModeCategory","EventLocationCountry","EventLocation","EventCode","EventStatus","TransportationOrder","TransportationOrderCategory"];this._aStaticFilters.push(new sap.ui.model.Filter("EventHandlerIsActiveFilter",sap.ui.model.FilterOperator.EQ,"X",null));this._aStaticFilters.push(new sap.ui.model.Filter("TransportationOrderCategoryFilter",sap.ui.model.FilterOperator.EQ,"TO",null));var w=this._fnBuildEHOElementsArray();var i=["chipId","evaluationId","sap-system","tileType","sap-language","sap-client","hc_orionpath","sap-ui-language","sap-ui-xx-fakeOS","origional-url","sap-ui-appCacheBuster","sap-ui-xx-componentPreload","responderOn"];if(this.getOwnerComponent().getComponentData()){u=this.getOwnerComponent().getComponentData().startupParameters}if(u&&w){for(var a in u){if(w.indexOf(a)>-1||D.indexOf(a)>-1){f.push(this.fnBuildParamFilters(u,a,D))}else if(i.indexOf(a)===-1){this._wrongProperty=a;this._error=true;u=null;f=[];break}}}if(u&&u.evaluationId){var K=new sap.ui.model.odata.ODataModel("/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata",true);K.read("/EVALUATIONS('"+u.evaluationId[0]+"')",{async:false,urlParameters:{$expand:"FILTERS"},success:function(o,r){for(j=0;j<r.data.FILTERS.results.length;j++){for(k=0;k<w.length;k++){if(r.data.FILTERS.results[j].NAME===D[k]){p=new sap.ui.model.Filter(r.data.FILTERS.results[j].NAME+"Filter",sap.ui.model.FilterOperator.EQ,r.data.FILTERS.results[j].VALUE_1,null);if(!t._oKeyValueMapping[r.data.FILTERS.results[j].NAME+"Filter"]){t._oKeyValueMapping[r.data.FILTERS.results[j].NAME+"Filter"]=[r.data.FILTERS.results[j].VALUE_1]}else{t._oKeyValueMapping[r.data.FILTERS.results[j].NAME+"Filter"].push(r.data.FILTERS.results[j].VALUE_1)}f.push(p)}}}}})}f=f.filter(function(F){if(F){return F}});if(f.length!==0){this.fnBindList(undefined,f);d=true}var P=sap.ushell.Container.getService("Personalization");P.getContainer("variants",{validity:Infinity},this.getOwnerComponent()).then(function(c){if(c.getItemValue("variantKey")){t._oVariants=c.getItemValue("variantKey");var v=t.getView().byId("filterVariantManagement");for(var b in t._oVariants){if(t._oVariants.hasOwnProperty(b)){var V=new sap.ui.comp.variants.VariantItem({key:t._oVariants[b]["@key"],text:b});v.addVariantItem(V);if(c.getItemValue("defaultVariant")&&c.getItemValue("defaultVariant")===t._oVariants[b]["@key"]){v.setDefaultVariantKey(c.getItemValue("defaultVariant"));v.setInitialSelectionKey(c.getItemValue("defaultVariant"));if(!d){t._oKeyValueMapping=t._oVariants[b];t.onFilterCategoryDialogOKButton(undefined,c.getItemValue("defaultVariant"))}}}}}});this.getOwnerComponent().getEventBus().subscribe("zzem.fo.visibility","refresh",this.refresh,this)},refresh:function(){sap.ui.core.UIComponent.getRouterFor(this).navTo("NoData",{},true);var l=this.getView().byId("list");var s=l.getSelectedItem();var m=this.getView().getModel();var c=s.getBindingContext().getPath();var t=this;this.getView().getModel().read("FreightOrderEventHandlerOverviewS",{async:false,filters:[new sap.ui.model.Filter("ODataSearchFieldFilter",sap.ui.model.FilterOperator.EQ,s.getBindingContext().getProperty("TransportationOrder"),null)],success:function(d){m.oData[c.substring(1)]=d.results[0];sap.ui.core.UIComponent.getRouterFor(t).navTo("Detail",{from:"master",contextPath:s.getBindingContext().getPath().substr(1)},true)}})},fnBuildParamFilters:function(u,p,d){var a=[];var l;var s="";for(l=0;l<u[p].length;l++){if(d.indexOf(p)>-1&&u[p][l]!=="SAP_SMARTBUSINESS_NULL"){if(p==="TransportationOrder"){s+=u[p][l]+",";a.push(new sap.ui.model.Filter("ODataSearchFieldFilter",sap.ui.model.FilterOperator.EQ,u[p][l],null));this.getView().byId("searchField").setValue(s.substring(0,s.length-1))}else{a.push(new sap.ui.model.Filter(p+"Filter",sap.ui.model.FilterOperator.EQ,u[p][l],null));if(this._oKeyValueMapping[p+"Filter"]){this._oKeyValueMapping[p+"Filter"].push(u[p][l])}else{this._oKeyValueMapping[p+"Filter"]=[u[p][l]]}}}else if(d.indexOf(p)===-1&&u[p][l]!=="SAP_SMARTBUSINESS_NULL"){a.push(new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.EQ,u[p][l],null));if(this._oKeyValueMapping[p]){this._oKeyValueMapping[p].push(u[p][l])}else{this._oKeyValueMapping[p]=[u[p][l]]}}}if(p==="TransportationOrder"){this._searchFilter=new sap.ui.model.Filter(a,false);return this._searchFilter}if(a.length>1){return new sap.ui.model.Filter(a,false)}return a[0]},fnBindList:function(s,a){this._aFilterArray=a||this._aFilterArray||[];var f=[];var t=this;jQuery.each(this._aStaticFilters,function(c,F){if(t._aFilterArray.indexOf(F)===-1){t._aFilterArray.push(F)}});if(s){if(this._aFilterArray.indexOf(this._searchFilter)>-1){this._aFilterArray.splice(this._aFilterArray.indexOf(this._searchFilter),1)}var S=s.split(',');var b=[];for(var i=0;i<S.length;i++){if(S[i]!==""){b.push(new sap.ui.model.Filter("ODataSearchFieldFilter",sap.ui.model.FilterOperator.EQ,S[i]))}}this._searchFilter=new sap.ui.model.Filter(b,false);this._aFilterArray.push(this._searchFilter);this.getView().byId("list").bindItems("/FreightOrderEventHandlerOverviewS",this._oListItemTemplate,null,this._aFilterArray);this.getView().byId("list").attachEventOnce("updateFinished",function(){this.fnSelectFirstItem()},this);return}else if(s===""){if(this._aFilterArray.indexOf(this._searchFilter)>-1){this._aFilterArray.splice(this._aFilterArray.indexOf(this._searchFilter),1)}this._searchFilter=undefined;f=this._aFilterArray.filter(function(F){return t._aStaticFilters.indexOf(F)===-1});if(f.length===0){sap.ui.core.UIComponent.getRouterFor(this).navTo("NoData",{},true);this.getView().getContent()[0].setTitle(this.getOwnerComponent().getResourceBundle().getText("MASTER_TITLE_NO_COUNT"));this.getView().byId("list").unbindItems();return}this.getView().byId("list").bindItems("/FreightOrderEventHandlerOverviewS",this._oListItemTemplate,null,this._aFilterArray);this.getView().byId("list").attachEventOnce("updateFinished",function(){this.fnSelectFirstItem()},this);return}if(this._searchFilter&&this._aFilterArray.indexOf(this._searchFilter)===-1){this._aFilterArray.push(this._searchFilter)}f=this._aFilterArray.filter(function(F){return t._aStaticFilters.indexOf(F)===-1});if(f.length===0){sap.ui.core.UIComponent.getRouterFor(this).navTo("NoData",{},true);this.getView().getContent()[0].setTitle(this.getOwnerComponent().getResourceBundle().getText("MASTER_TITLE_NO_COUNT"));this.getView().byId("list").unbindItems();return}this.getView().byId("list").bindItems("/FreightOrderEventHandlerOverviewS",this._oListItemTemplate,null,this._aFilterArray);this.getView().byId("list").attachEventOnce("updateFinished",function(){this.fnSelectFirstItem()},this)},fnSelectFirstItem:function(){if(this.getView().byId("list").getItems().length!==0){this.getView().byId("list").fireSelectionChange({listItem:this.getView().byId("list").getItems()[0]});this.getView().byId("list").setSelectedItem(this.getView().byId("list").getItems()[0]);this.getView().getContent()[0].setTitle(this.getOwnerComponent().getResourceBundle().getText("MASTER_TITLE",[this.getView().byId("list").getBinding("items").getLength()]))}else{sap.ui.core.UIComponent.getRouterFor(this).navTo("NoData",{},true);this.getView().byId("list").unbindItems();this.getView().getContent()[0].setTitle(this.getOwnerComponent().getResourceBundle().getText("MASTER_TITLE_NO_COUNT"))}},onAfterRendering:function(){if(this._error){jQuery.sap.require("sap.ca.ui.message.message");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.getOwnerComponent().getResourceBundle().getText("MSG_FILTER")+" "+this._wrongProperty+" "+this.getOwnerComponent().getResourceBundle().getText("MSG_ERROR_FILTER")})}},handleSearch:function(){sap.ui.core.UIComponent.getRouterFor(this).navTo("NoData",{},true);var s=this.getView().byId("searchField").getValue();this.fnBindList(s)},handleSelect:function(e){var l=e.getParameter("listItem")||e.getSource();sap.ui.core.UIComponent.getRouterFor(this).navTo("Detail",{from:"master",contextPath:l.getBindingContext().getPath().substr(1)},true)},_fnBuildEHOElementsArray:function(){var w=[];w.push("ODataSearchFieldFilter");w.push("TransportationOrder");w.push("CarrierFilter");w.push("TransportationStatusFilter");w.push("TransportationModeFilter");w.push("TransportationPhaseFilter");w.push("TransportationOrderCategoryFilter");w.push("SourceLocationFilter");w.push("SourceLocationCityNameFilter");w.push("SourceLocationCountryFilter");w.push("ShippingTypeFilter");w.push("P_CalendarTimeFrameFilter");w.push("P_TimeZoneFilter");w.push("EventLocationCountryFilter");w.push("EventCodeFilter");w.push("EventStatusFilter");w.push("DeliveryStatusFilter");w.push("DestinationLocationCityNameFilter");w.push("DestinationLocationFilter");w.push("DestinationLocationCountryFilter");w.push("EventHandlerIsActiveFilter");w.push("TransportationModeCategoryFilter");return w},onFilterButtonPress:function(){this.getView().byId("FilterDialog").open();var t=this;this.getView().byId("FilterCategoryList").getItems().forEach(function(e,i,a){for(var s in t._oKeyValueMapping){if(s===t.getView().byId("FilterCategoryList").getItems()[i].getAggregation("customData")[0].getProperty("value")){if(t._oKeyValueMapping[s]){a[i].setCounter(t._oKeyValueMapping[s].length)}else{a[i].setCounter(0)}}}})},onFilterCategoryPress:function(e){var E=e.getSource().getCustomData()[1].getValue();var s=this.getView().getModel().getProperty("/#"+E.substring(0,E.length-1)+"/Identifier/@sap:emSelectionFieldProperty");var S=e.getSource().getCustomData()[2].getValue();var c=this.getView().getModel().getProperty("/#"+E.substring(0,E.length-1)+"/Identifier/@sap:label");var f=this._getValueDialog(true);f.getCustomData()[0].setValue(s);f.setModel(this.getView().getModel("i18n"),"i18n");f.setModel(this.getView().getModel("device"),"device");f.setModel(this.getView().getModel());f.getCustomHeader().getContentMiddle()[0].setText(this.getOwnerComponent().getResourceBundle().getText("FILTER_VALUE_TITLE",[c]));f.getSubHeader().getContentMiddle()[0].setPlaceholder(this.getOwnerComponent().getResourceBundle().getText("FILTER_VALUE_SEARCH_PLACEHOLDER",[c]));var i=f.getContent()[0].getItems()[0].clone();var C;if(S==="true"){C=new sap.m.RadioButton({groupName:E})}else{C=new sap.m.CheckBox()}C.attachSelect(this.onValueSelect,this);i.addContent(C);f.getContent()[0].bindItems("/"+E,i,null,null);f.open()},onValueSelect:function(e){var s=this._getValueDialog().getCustomData()[0].getValue();if(e.getSource().getMetadata().getName()==="sap.m.RadioButton"||!this._oKeyValueMapping[s]){this._aFilterValues=[]}else{this._aFilterValues=this._oKeyValueMapping[s]}if(e.getSource().getSelected()){this._aFilterValues.push(e.getSource().getParent().getBindingContext().getProperty("Identifier"))}else{this._aFilterValues.splice(this._aFilterValues.indexOf(e.getSource().getParent().getBindingContext().getProperty("Identifier")),1)}if(this._aFilterValues.length===0){e.getSource().getParent().getParent().getParent().getButtons()[0].setEnabled(false);if(this._getValueDialog().getButtons()[0].getPressed()){this._getValueDialog().getButtons()[0].setPressed(false);var f=[];f=e.getSource().getParent().getParent().getBinding("items").aFilters;f=f.filter(function(F){return F.sPath==="Description"});e.getSource().getParent().getParent().getBinding("items").filter(f)}}else{this._getValueDialog().getButtons()[0].setEnabled(true)}this._oKeyValueMapping[s]=this._aFilterValues.slice();if(this.getView().byId("filterVariantManagement")){for(var v in this._oVariants){if(this._oVariants.hasOwnProperty(v)){if(JSON.stringify(this._oKeyValueMapping)===JSON.stringify(v)){return}}}this.getView().byId("filterVariantManagement").currentVariantSetModified(true)}},onDialogCancelButtonPress:function(){this._getValueDialog().close();this.resetTmpKeyValueMapping()},resetTmpKeyValueMapping:function(){if(this._oTmpKeyValueMapping){this._oKeyValueMapping=jQuery.extend({},this._oTmpKeyValueMapping)}},onCategoryDialogCancelButtonPress:function(){this.getView().byId("FilterDialog").close();this.resetTmpKeyValueMapping()},onShowSelectedCheck:function(e){var l=this._getValueDialog().getContent()[0];var s=this._getValueDialog().getCustomData()[0].getValue();this._getValueDialog().getSubHeader().getContentMiddle()[0].setValue("");var S=this._oKeyValueMapping[s];var f=[];if(e.getSource().getProperty("pressed")){for(var i=0;i<S.length;i++){var I=new sap.ui.model.Filter("Identifier",sap.ui.model.FilterOperator.EQ,S[i],null);f.push(I)}}l.getBinding("items").filter(f)},onValueDialogOKButtonPress:function(){var s=this._getValueDialog().getCustomData()[0].getValue();var t=this;this.getView().byId("FilterCategoryList").getItems().forEach(function(e,i,a){if(s===t.getView().byId("FilterCategoryList").getItems()[i].getAggregation("customData")[0].getProperty("value")){if(t._oKeyValueMapping[s]){a[i].setCounter(t._oKeyValueMapping[s].length)}else{a[i].setCounter(0)}}});this._aFilterValues=[];this._oTmpKeyValueMapping=jQuery.extend({},this._oKeyValueMapping);this._getValueDialog().close()},onFilterValueListUpdateFinished:function(e){var l=e.getSource().getItems();if(l.length>0){var s=this._oKeyValueMapping[e.getSource().getParent().getCustomData()[0].getValue()];if(s){e.getSource().getParent().getButtons()[0].setEnabled(true);for(var i=0;i<l.length;i++){var L=l[i].getBindingContext().getProperty("Identifier");if(s.indexOf(L)!==-1){l[i].getContent()[0].setSelected(true)}}}}},onValueDialogRefreshPress:function(){var s=this._getValueDialog().getCustomData()[0].getValue();this._getValueDialog().getButtons()[0].setEnabled(false);this._getValueDialog().getButtons()[0].setPressed(false);this._getValueDialog().getSubHeader().getContentMiddle()[0].setValue("");delete this._oKeyValueMapping[s];var f=this._getValueDialog().getContent()[0].getItems();for(var i=0;i<f.length;i++){f[i].getContent()[0].setSelected(false)}this._aFilterValues=[];this._getValueDialog().getContent()[0].getBinding("items").filter()},onValueDialogSearch:function(e){var l=this._getValueDialog().getContent()[0];var f=l.getBinding("items").aFilters;this._getValueDialog().getButtons()[0].setPressed(false);if(e.getParameter("query")){f=[new sap.ui.model.Filter("Description",sap.ui.model.FilterOperator.Contains,e.getParameter("query"),null)]}else{f=f.filter(function(a){return a.sPath!=="Description"})}l.getBinding("items").filter(f)},onFilterCategoryRefresh:function(){this._oTmpKeyValueMapping=jQuery.extend({},this._oKeyValueMapping);this._oKeyValueMapping={};this.getView().byId("FilterCategoryList").getItems().forEach(function(e,i,a){a[i].setCounter(0)})},onFilterCategoryDialogOKButton:function(e,d){var f=[];var k;var F=function(b){var o=new sap.ui.model.Filter(k,sap.ui.model.FilterOperator.EQ,b,null);f.push(o)};var K=[];for(k in this._oKeyValueMapping){if(this._oKeyValueMapping.hasOwnProperty(k)&&this._oKeyValueMapping[k].length!==0){if(k==="@key"){continue}this._oKeyValueMapping[k].forEach(F);K.push(k)}}var I=this.getView().byId("listInfoToolbar");if(f.length!==0){var v=this.getView().byId("filterVariantManagement");I.setVisible(true);if(this.getView().byId("searchField").getValue()){var s=this.getView().byId("searchField").getValue().split(',');var S=[];for(var i=0;i<s.length;i++){if(s[i]!==""){S.push(new sap.ui.model.Filter("ODataSearchFieldFilter",sap.ui.model.FilterOperator.EQ,s[i]))}}this._searchFilter=new sap.ui.model.Filter(S,false);f.push(this._searchFilter)}else{this._searchFilter=undefined}this.fnBindList(undefined,f);var a;if(d){a=d}else{a=v.getSelectionKey()}var t;if(a!==null&&a!=="*standard*"){var V=v.getVariantItems().filter(function(o){return o.getKey()===a});if(V.length!==0){t=this.getOwnerComponent().getResourceBundle().getText("INFO_TEXT",[V[0].getText()])}else{V=v.getItems().filter(function(o){return o.getKey()===a});if(V.length!==0){t=this.getOwnerComponent().getResourceBundle().getText("INFO_TEXT",[V[0].getText()])}}}else{var l=this.getView().byId("FilterDialog").getContent()[0].getItems();var c=[];l.forEach(function(L){if(K.indexOf(L.getCustomData()[0].getValue())!==-1){c.push(L.getTitle())}});if(c.length===1){t=this.getOwnerComponent().getResourceBundle().getText("INFO_TEXT",c)}else{t=this.getOwnerComponent().getResourceBundle().getText("INFO_TEXT_MULTIPLE")}}I.getContent()[0].setText(t);I.setVisible(true)}else{if(this._aFilterArray){this._aFilterArray=this._aFilterArray.filter(function(o){return o.sPath==="ODataSearchFieldFilter"});this.fnBindList(undefined,this._aFilterArray)}I.setVisible(false)}this._oTmpKeyValueMapping=undefined;this.getView().byId("FilterDialog").close()},onVariantSelect:function(e){var t=this;var p;var u={};var l;this.getView().byId("FilterCategoryList").getItems().forEach(function(a,i){t.getView().byId("FilterCategoryList").getItems()[i].setCounter(0)});var s=function(a,i){if(p===t.getView().byId("FilterCategoryList").getItems()[i].getAggregation("customData")[0].getProperty("value")){t.getView().byId("FilterCategoryList").getItems()[i].setCounter(l)}};for(var v in this._oVariants){if(this._oVariants.hasOwnProperty(v)&&this._oVariants[v]["@key"]===e.getParameter("key")){for(p in this._oVariants[v]){if(this._oVariants[v].hasOwnProperty(p)){if(p==="@key"){continue}l=this._oVariants[v][p].length;this.getView().byId("FilterCategoryList").getItems().forEach(s)}}jQuery.extend(u,this._oVariants[v]);break}}this._oKeyValueMapping=u},onVariantSave:function(e){if(e.getId()){var t=this;var k=e.getParameter("key");var n=e.getParameter("name");var p=sap.ushell.Container.getService("Personalization");var u={};jQuery.extend(u,this._oKeyValueMapping);this._oVariants[n]=u;this._oVariants[n]["@key"]=k;p.createEmptyContainer("variants",{validity:Infinity},this.getOwnerComponent()).then(function(c){c.setItemValue("variantKey",t._oVariants);if(t.getView().byId("filterVariantManagement").getDefaultVariantKey()!=="*standard*"){c.setItemValue("defaultVariant",t.getView().byId("filterVariantManagement").getDefaultVariantKey())}c.save()})}},onVariantManage:function(e){var t=this;var p=sap.ushell.Container.getService("Personalization");var n={};var v;var f=function(R){if(R.key===t._oVariants[v]["@key"]){n[R.name]=t._oVariants[v]}};var r=[];e.getParameter("renamed").forEach(function(k){r.push(k.key)});for(v in this._oVariants){if(e.getParameter("deleted").indexOf(this._oVariants[v]["@key"])!==-1){continue}if(r.indexOf(this._oVariants[v]["@key"])!==-1){e.getParameter("renamed").forEach(f)}else{n[v]=this._oVariants[v]}}this._oVariants=jQuery.extend({},n);p.createEmptyContainer("variants",{validity:Infinity},this.getOwnerComponent()).then(function(c){c.setItemValue("variantKey",t._oVariants);if(e.getParameter("def")&&e.getParameter("def")!=="*standard*"){c.setItemValue("defaultVariant",e.getParameter("def"))}c.save()})}});